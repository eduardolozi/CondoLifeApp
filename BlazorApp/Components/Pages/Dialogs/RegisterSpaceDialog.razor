@layout Layout.MainLayout
@inject SpaceService SpaceService
@inject IDialogService DialogService

<MudDialog Class="w-50">
    <DialogContent>
        <MudContainer Class="w-100 flex-column align-items-start">
            <MudTextField @bind-Value="_space.Name"
                          Placeholder="Nome do espaço"
                          Variant="Variant.Outlined"
                          Style="width: 100%">
            </MudTextField>
            <MudImage Class="mt-4 mb-2" Elevation="1" Style="width: 100%;" Height="300"  Src="@(_space.Photo is null ? null : $"data:image/png;base64,{_space.Photo.ContentBase64}")"></MudImage>
            <MudFileUpload Class="mb-4" T="IBrowserFile" FilesChanged="UploadImage" Accept=".png, .jpg">
                <ActivatorContent>
                    <MudContainer Class="d-flex flex-row p-0">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   Style="width: 100%">
                            Selecione a foto
                        </MudButton>
                    </MudContainer>
                </ActivatorContent>
            </MudFileUpload>
            <MudText Class="fw-bold">Disponibilidade</MudText>
            <MudSwitch @bind-Value="_space.Availability"
                       ThumbIcon="@(_space.Availability ? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                       ThumbIconColor="@(_space.Availability ? Color.Success : Color.Error)">
            </MudSwitch>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Success"
                   Variant="Variant.Filled"
                   OnClick="Submit"
                   Class="mb-2 me-2">
            Adicionar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; }
    [Parameter] public int CondominiumId { get; set; }
    Space _space = new();
    
    private async Task Submit()
    {
        try
        {
            _space.CondominiumId = CondominiumId;
            await SpaceService.Add(_space);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception e)
        {
            await DialogService.ShowMessageBox("Erro!", e.Message, "Ok");
        }
    } 
    
    async Task UploadImage(IBrowserFile file)
    {
        using var memoryStream = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(memoryStream);
        var fileBytes = memoryStream.ToArray();
        _space.Photo = new Photo
        {
            ContentBase64 = Convert.ToBase64String(fileBytes),
            ContentType = file.ContentType,
            FileName = file.Name
        };
        StateHasChanged();
    }
}